<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Electricity Dashboard - Spain</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #374151;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chart-container {
            position: relative;
            height: 500px; /* Increased height for the main chart */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Live Electricity Dashboard</h1>
            <p class="text-lg text-gray-400 mt-2">Daily generation mix vs. consumption for Spain (Mainland)</p>
            <p id="last-updated" class="text-sm text-gray-500 mt-2">Last updated: --:--:--</p>
        </header>

        <main>
            <div id="loading-state" class="flex flex-col items-center justify-center h-64">
                <div class="loader"></div>
                <p class="mt-4 text-gray-400">Fetching daily data...</p>
            </div>
            
            <div id="data-state" class="hidden">
                <!-- Main Daily Mix Chart -->
                <div class="bg-gray-800 p-4 md:p-6 rounded-2xl mb-8">
                    <h3 class="text-xl font-semibold mb-4 text-center text-white">Today's Generation Mix vs. Consumption</h3>
                    <div class="chart-container">
                        <canvas id="dailyMixChart"></canvas>
                    </div>
                </div>

                <!-- Bottom Row: Installed Capacity -->
                <div class="bg-gray-800 p-4 md:p-6 rounded-2xl">
                    <h3 class="text-xl font-semibold mb-4 text-center text-white">Installed Generation Capacity</h3>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="capacityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div id="error-message" class="hidden mt-8 p-4 bg-red-900/50 border border-red-700 rounded-lg text-center">
                <h3 class="font-bold text-red-300">Error Loading Data</h3>
                <p id="error-details" class="text-red-400 mt-1"></p>
            </div>
        </main>

        <footer class="text-center mt-12">
            <p class="text-sm text-gray-500">Data provided by the <a href="https://transparency.entsoe.eu/" target="_blank" rel="noopener noreferrer" class="underline hover:text-blue-400">ENTSO-E Transparency Platform</a>.</p>
        </footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURATION ---
        const SECURITY_TOKEN = "709241ab-e674-4acc-ac81-6a8dc984bd98"; 
        const REFRESH_INTERVAL_SECONDS = 300;

        // --- DOM ELEMENTS ---
        const loadingState = document.getElementById('loading-state');
        const dataState = document.getElementById('data-state');
        const errorMessageEl = document.getElementById('error-message');
        const errorDetailsEl = document.getElementById('error-details');
        const lastUpdatedEl = document.getElementById('last-updated');
        const dailyMixCanvas = document.getElementById('dailyMixChart');
        const capacityCanvas = document.getElementById('capacityChart');
        let dailyMixChart = null;
        let capacityChart = null;

        const generationTypeMapping = {
            'Solar': { name: 'Solar', color: '#f59e0b' },
            'Wind': { name: 'Wind', color: '#38bdf8' },
            'Hydro': { name: 'Hydro', color: '#3b82f6' },
            'Nuclear': { name: 'Nuclear', color: '#be123c' },
            'Fossil Fuels': { name: 'Fossil Fuels', color: '#6b7280' },
            'Biomass': { name: 'Biomass', color: '#16a34a' },
            'Other': { name: 'Other', color: '#a8a29e' }
        };
        
        function getColorForType(type) {
             return generationTypeMapping[type]?.color || generationTypeMapping['Other'].color;
        }

        function displayError(message) {
            errorDetailsEl.textContent = message;
            errorMessageEl.classList.remove('hidden');
            loadingState.classList.add('hidden');
            dataState.classList.add('hidden');
        }

        const formatDate = (date) => date.toISOString().replace(/[:T.-]/g, '').slice(0, 12);

        function getDailyApiDateRange() {
            const now = new Date();
            const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
            const end = new Date(start);
            end.setUTCDate(end.getUTCDate() + 1);
            return { start: formatDate(start), end: formatDate(end) };
        }

        function getCapacityApiDateRange() {
            const now = new Date();
            const end = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 23, 59, 59));
            const start = new Date(end);
            start.setUTCDate(start.getUTCDate() - 365);
            start.setUTCHours(0,0,0,0);
            return { start: formatDate(start), end: formatDate(end) };
        }

        async function fetchApiData(documentType, periodStart, periodEnd) {
            const domain = '10YES-REE------0'; // Spain
            const proxyUrl = 'https://api.allorigins.win/raw?url=';
            
            const domainParamKey = (documentType === 'A65') ? 'outBiddingZone_Domain' : 'in_Domain';
            const processType = (documentType === 'A68') ? 'A33' : 'A16';

            const apiUrl = `https://web-api.tp.entsoe.eu/api?securityToken=${SECURITY_TOKEN}&documentType=${documentType}&processType=${processType}&${domainParamKey}=${domain}&periodStart=${periodStart}&periodEnd=${periodEnd}`;
            
            const response = await fetch(proxyUrl + encodeURIComponent(apiUrl));
            if (!response.ok) throw new Error(`Network error: ${response.statusText} (Code: ${response.status})`);
            
            const xmlText = await response.text();
            const parser = new DOMParser();
            return parser.parseFromString(xmlText, "application/xml");
        }

        async function fetchAllData() {
            loadingState.classList.remove('hidden');
            errorMessageEl.classList.add('hidden');
            dataState.classList.add('hidden');

            if (!SECURITY_TOKEN) {
                displayError("API Token is not configured.");
                return;
            }

            try {
                const dailyDates = getDailyApiDateRange();
                const capacityDates = getCapacityApiDateRange();

                const [generationXml, loadXml, capacityXml] = await Promise.all([
                    fetchApiData('A75', dailyDates.start, dailyDates.end),
                    fetchApiData('A65', dailyDates.start, dailyDates.end),
                    fetchApiData('A68', capacityDates.start, capacityDates.end)
                ]);

                const timeSeriesData = processTimeSeriesData(generationXml, loadXml);
                updateDailyMixChart(timeSeriesData);
                
                const capacityData = processCapacityData(capacityXml);
                updateCapacityChart(capacityData);

                dataState.classList.remove('hidden');
                loadingState.classList.add('hidden');
                lastUpdatedEl.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;

            } catch (error) {
                console.error("Fetch Error:", error);
                displayError(error.message);
            }
        }
        
        function getCategoryForPsrType(psrType) {
            const mapping = {
                'Solar': ['B16'],
                'Wind': ['B18', 'B19'],
                'Hydro': ['B10', 'B11', 'B12'],
                'Nuclear': ['B14'],
                'Fossil Fuels': ['B02', 'B03', 'B04', 'B05', 'B06', 'B07', 'B08'],
                'Biomass': ['B01'],
            };
            for (const category in mapping) {
                if (mapping[category].includes(psrType)) {
                    return category;
                }
            }
            return 'Other'; // Default for Geothermal, Waste, Other renewable, etc.
        }

        function processTimeSeriesData(generationXml, loadXml) {
             const genReasonNode = generationXml.querySelector('Reason > text');
             if (genReasonNode) throw new Error(`API Error (Generation): ${genReasonNode.textContent}`);
             const loadReasonNode = loadXml.querySelector('Reason > text');
             if (loadReasonNode) throw new Error(`API Error (Load): ${loadReasonNode.textContent}`);

             const genSeries = generationXml.querySelectorAll('TimeSeries');
             const loadSeries = loadXml.querySelector('TimeSeries');
             if (genSeries.length === 0 || !loadSeries) throw new Error("Generation or load data is missing from API response.");

             const resolution = loadSeries.querySelector('resolution')?.textContent;
             let minutesIncrement = 60;
             if (resolution === 'PT30M') minutesIncrement = 30;
             if (resolution === 'PT15M') minutesIncrement = 15;
             
             const startTime = new Date(loadSeries.querySelector('start')?.textContent);
             const labels = Array.from(loadSeries.querySelectorAll('Point')).map((p, i) => {
                 return new Date(startTime.getTime() + i * minutesIncrement * 60 * 1000);
             });

             const loadData = Array.from(loadSeries.querySelectorAll('Point')).map(p => parseInt(p.querySelector('quantity').textContent, 10));

             const aggregatedData = {
                'Solar': new Array(labels.length).fill(0),
                'Wind': new Array(labels.length).fill(0),
                'Hydro': new Array(labels.length).fill(0),
                'Nuclear': new Array(labels.length).fill(0),
                'Fossil Fuels': new Array(labels.length).fill(0),
                'Biomass': new Array(labels.length).fill(0),
                'Other': new Array(labels.length).fill(0)
             };

             genSeries.forEach(series => {
                const psrType = series.querySelector('MktPSRType > psrType')?.textContent;
                if (!psrType) return;
                
                const category = getCategoryForPsrType(psrType);
                const points = Array.from(series.querySelectorAll('Point')).map(p => parseInt(p.querySelector('quantity').textContent, 10));

                for (let i = 0; i < points.length && i < labels.length; i++) {
                    aggregatedData[category][i] += points[i];
                }
             });

             return { labels, datasets: aggregatedData, loadData };
        }
        
        function updateDailyMixChart({ labels, datasets, loadData }) {
            const chartDatasets = [];
            const generationOrder = ['Hydro', 'Other', 'Biomass', 'Fossil Fuels', 'Nuclear', 'Wind', 'Solar'];

            generationOrder.forEach(name => {
                if (datasets[name]) {
                    chartDatasets.push({
                        label: name,
                        data: datasets[name],
                        backgroundColor: getColorForType(name),
                        borderColor: getColorForType(name),
                        fill: true,
                        pointRadius: 0,
                        borderWidth: 0,
                    });
                }
            });

            chartDatasets.push({
                label: 'Consumption (Load)',
                data: loadData,
                borderColor: '#60a5fa',
                backgroundColor: 'transparent',
                borderWidth: 3,
                pointRadius: 0,
                fill: false,
                order: -1
            });

            const chartData = { labels: labels, datasets: chartDatasets };
            
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: { 
                        stacked: true,
                        ticks: { color: '#9ca3af', callback: value => `${(value / 1000).toFixed(1)} GW` },
                        grid: { color: 'rgba(156, 163, 175, 0.2)' } 
                    },
                    x: {
                        type: 'time',
                        time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } },
                        ticks: { color: '#9ca3af' },
                        grid: { color: 'rgba(156, 163, 175, 0.2)' }
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#d1d5db' }
                    },
                    tooltip: {
                        enabled: true,
                        backgroundColor: '#1f2937',
                        callbacks: {
                            label: (context) => `${context.dataset.label}: ${context.parsed.y.toLocaleString()} MW`
                        }
                    }
                }
            };
            
            if (dailyMixChart) {
                dailyMixChart.data = chartData;
                dailyMixChart.options = chartOptions;
                dailyMixChart.update();
            } else {
                dailyMixChart = new Chart(dailyMixCanvas, { type: 'line', data: chartData, options: chartOptions });
            }
        }
        
        function processCapacityData(xmlDoc) {
             const reasonNode = xmlDoc.querySelector('Reason > text');
             if (reasonNode) throw new Error(`API Error (Capacity): ${reasonNode.textContent}`);
             const series = xmlDoc.querySelectorAll('TimeSeries');
             if (series.length === 0) return {};
             const capacityData = {};
             Array.from(series).forEach(s => {
                 const typeCode = s.querySelector('MktPSRType > psrType')?.textContent;
                 if (!typeCode) return;
                 const category = getCategoryForPsrType(typeCode);
                 const point = s.querySelector('Point');
                 if (point) {
                     const value = parseInt(point.querySelector('quantity').textContent, 10);
                     if (!capacityData[category]) capacityData[category] = 0;
                     capacityData[category] += value;
                 }
             });
             return capacityData;
        }

        function updateCapacityChart(capacityData) {
            if (Object.keys(capacityData).length === 0) {
                document.getElementById('capacityChart').parentElement.parentElement.style.display = 'none';
                return;
            } else {
                 document.getElementById('capacityChart').parentElement.parentElement.style.display = 'block';
            }

            const finalData = Object.entries(capacityData)
                .map(([name, value]) => ({ name, value }))
                .filter(item => item.value > 0)
                .sort((a, b) => b.value - a.value);

            const chartData = {
                labels: finalData.map(item => item.name),
                datasets: [{
                    label: 'Installed Capacity (MW)',
                    data: finalData.map(item => item.value),
                    backgroundColor: finalData.map(item => getColorForType(item.name))
                }]
            };
            const chartOptions = {
                indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { ticks: { color: '#9ca3af', callback: value => `${(value / 1000).toFixed(1)} GW` }, grid: { color: 'rgba(156, 163, 175, 0.2)' } },
                    y: { ticks: { color: '#9ca3af' }, grid: { display: false } }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: true, backgroundColor: '#1f2937',
                        callbacks: {
                            label: (context) => `${context.label}: ${context.parsed.x.toLocaleString()} MW`
                        }
                    }
                }
            };
            if (capacityChart) {
                capacityChart.data = chartData;
                capacityChart.update();
            } else {
                capacityChart = new Chart(capacityCanvas, { type: 'bar', data: chartData, options: chartOptions });
            }
        }

        fetchAllData();
        setInterval(fetchAllData, REFRESH_INTERVAL_SECONDS * 1000);
    });
    </script>
</body>
</html>

