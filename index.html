<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Electricity Generation - Spain</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #374151;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chart-container {
            position: relative;
            height: 350px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .legend-color {
            width: 1rem;
            height: 1rem;
            border-radius: 0.25rem;
            margin-right: 0.75rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Live Electricity Generation Dashboard</h1>
            <p class="text-lg text-gray-400 mt-2">Real-time energy mix for Spain (Mainland)</p>
            <p id="last-updated" class="text-sm text-gray-500 mt-2">Last updated: --:--:--</p>
        </header>

        <main>
            <div id="loading-state" class="flex flex-col items-center justify-center h-64">
                <div class="loader"></div>
                <p class="mt-4 text-gray-400">Fetching live data...</p>
            </div>
            
            <div id="data-state" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Generation Mix Chart -->
                    <div class="lg:col-span-2 bg-gray-800 p-4 md:p-6 rounded-2xl">
                        <h3 class="text-xl font-semibold mb-4 text-center text-white">Current Generation Mix</h3>
                        <div class="chart-container">
                            <canvas id="generationMixChart"></canvas>
                        </div>
                    </div>

                    <!-- Legend and Totals -->
                    <div class="bg-gray-800 p-4 md:p-6 rounded-2xl flex flex-col justify-center">
                        <h3 class="text-xl font-semibold mb-4 text-white">Live Production (MW)</h3>
                        <div id="legend-container" class="flex-grow"></div>
                        <div class="border-t border-gray-700 mt-4 pt-4">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-lg">Total Production</span>
                                <span id="total-production" class="font-bold text-lg text-blue-400">-- MW</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div id="error-message" class="hidden mt-8 p-4 bg-red-900/50 border border-red-700 rounded-lg text-center">
                <h3 class="font-bold text-red-300">Error Loading Data</h3>
                <p id="error-details" class="text-red-400 mt-1"></p>
            </div>
        </main>

        <footer class="text-center mt-12">
            <p class="text-sm text-gray-500">Data provided by the <a href="https://transparency.entsoe.eu/" target="_blank" rel="noopener noreferrer" class="underline hover:text-blue-400">ENTSO-E Transparency Platform</a>.</p>
        </footer>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- CONFIGURATION ---
        const SECURITY_TOKEN = "709241ab-e674-4acc-ac81-6a8dc984bd98"; 
        const REFRESH_INTERVAL_SECONDS = 300; // Refresh every 5 minutes

        const loadingState = document.getElementById('loading-state');
        const dataState = document.getElementById('data-state');
        const errorMessageEl = document.getElementById('error-message');
        const errorDetailsEl = document.getElementById('error-details');
        const legendContainer = document.getElementById('legend-container');
        const totalProductionEl = document.getElementById('total-production');
        const lastUpdatedEl = document.getElementById('last-updated');
        const generationMixCanvas = document.getElementById('generationMixChart');
        let generationMixChart = null;

        const generationTypeMapping = {
            'B01': { name: 'Biomass', color: '#166534' },
            'B09': { name: 'Geothermal', color: '#7f1d1d' },
            'B10': { name: 'Hydro Pumped Storage', color: '#367280' },
            'B11': { name: 'Hydro Run-of-river', color: '#2563eb' },
            'B12': { name: 'Hydro Water Reservoir', color: '#3b82f6' },
            'B14': { name: 'Nuclear', color: '#be123c' },
            'B15': { name: 'Other renewable', color: '#15803d' },
            'B16': { name: 'Solar', color: '#f59e0b' },
            'B18': { name: 'Wind Offshore', color: '#22d3ee' },
            'B19': { name: 'Wind Onshore', color: '#67e8f9' },
            'B04': { name: 'Fossil Gas', color: '#a16207' },
            'B05': { name: 'Fossil Hard coal', color: '#374151' },
            'B06': { name: 'Fossil Oil', color: '#1f2937' },
            'B08': { name: 'Fossil Peat', color: '#44403c' },
            'Fossil': { name: 'Fossil Fuels', color: '#78716c' },
            'Hydro': { name: 'Hydro', color: '#2563eb'},
            'Wind': { name: 'Wind', color: '#22d3ee' },
            'Other': { name: 'Other', color: '#a8a29e' }
        };

        function displayError(message) {
            errorDetailsEl.textContent = message;
            errorMessageEl.classList.remove('hidden');
            loadingState.classList.add('hidden');
            dataState.classList.add('hidden');
        }

        // --- FIXED DATE RANGE FUNCTION ---
        function getApiDateRange() {
            const now = new Date();
            
            // Set end time to the beginning of the current hour in UTC
            const end = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), now.getUTCHours()));
            
            // Set start time to 2 hours before the end time
            const start = new Date(end.getTime() - (2 * 60 * 60 * 1000));

            const formatDate = (date) => {
                // Formats to YYYYMMDDHHMM (UTC)
                return date.toISOString().replace(/[:T.-]/g, '').slice(0, 12);
            };

            return { start: formatDate(start), end: formatDate(end) };
        }

        async function fetchData() {
            loadingState.classList.remove('hidden');
            errorMessageEl.classList.add('hidden');
            dataState.classList.add('hidden');

            if (!SECURITY_TOKEN) {
                displayError("API Token is not configured.");
                return;
            }

            const { start, end } = getApiDateRange();
            const domain = '10YES-REE------0'; // Spain
            const proxyUrl = 'https://api.allorigins.win/raw?url=';
            const apiUrl = `https://web-api.tp.entsoe.eu/api?securityToken=${SECURITY_TOKEN}&documentType=A75&processType=A16&in_Domain=${domain}&periodStart=${start}&periodEnd=${end}`;

            try {
                const response = await fetch(proxyUrl + encodeURIComponent(apiUrl));
                if (!response.ok) throw new Error(`Network error: ${response.statusText} (Code: ${response.status})`);

                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "application/xml");
                
                const reasonNode = xmlDoc.querySelector('Reason > text');
                if (reasonNode) {
                    throw new Error(`API Error: ${reasonNode.textContent}`);
                }

                const series = xmlDoc.querySelectorAll('TimeSeries');
                if (series.length === 0) throw new Error("No generation data found in the response. The API might be temporarily unavailable or the data for the requested period is missing.");

                const generationData = Array.from(series).map(s => {
                    const typeCode = s.querySelector('MktPSRType > psrType').textContent;
                    const points = s.querySelectorAll('Point');
                    const latestPoint = points[points.length - 1];
                    if (!latestPoint) return null;
                    return {
                        type: generationTypeMapping[typeCode]?.name || 'Other',
                        value: parseInt(latestPoint.querySelector('quantity').textContent, 10)
                    };
                }).filter(d => d && d.value > 0);
                
                if (generationData.length === 0) {
                     throw new Error("Data was returned, but it contained no valid generation points for the current timeframe.");
                }
                
                processAndDisplayData(generationData);

            } catch (error) {
                console.error("Fetch Error:", error);
                displayError(error.message);
            }
        }

        function processAndDisplayData(data) {
             const aggregatedData = {
                 'Solar': 0, 'Wind': 0, 'Hydro': 0, 'Biomass': 0, 'Nuclear': 0, 
                 'Fossil Fuels': 0, 'Geothermal': 0, 'Other': 0
             };

            data.forEach(item => {
                if (item.type.includes('Solar')) aggregatedData['Solar'] += item.value;
                else if (item.type.includes('Wind')) aggregatedData['Wind'] += item.value;
                else if (item.type.includes('Hydro')) aggregatedData['Hydro'] += item.value;
                else if (item.type.includes('Biomass')) aggregatedData['Biomass'] += item.value;
                else if (item.type.includes('Nuclear')) aggregatedData['Nuclear'] += item.value;
                else if (item.type.includes('Geothermal')) aggregatedData['Geothermal'] += item.value;
                else if (item.type.includes('Fossil') || item.type.includes('coal') || item.type.includes('Gas') || item.type.includes('Oil')) aggregatedData['Fossil Fuels'] += item.value;
                else aggregatedData['Other'] += item.value;
            });

            const finalData = Object.entries(aggregatedData)
                .map(([name, value]) => ({ name, value }))
                .filter(item => item.value > 10)
                .sort((a, b) => b.value - a.value);

            updateUI(finalData);
        }

        function updateUI(data) {
            loadingState.classList.add('hidden');
            dataState.classList.remove('hidden');
            errorMessageEl.classList.add('hidden');

            const totalProduction = data.reduce((sum, item) => sum + item.value, 0);
            totalProductionEl.textContent = `${totalProduction.toLocaleString()} MW`;

            lastUpdatedEl.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;

            legendContainer.innerHTML = '';
            data.forEach(item => {
                const typeInfo = Object.values(generationTypeMapping).find(t => t.name === item.name);
                const color = typeInfo ? typeInfo.color : '#a8a29e';
                const percentage = totalProduction > 0 ? ((item.value / totalProduction) * 100).toFixed(1) : 0;

                const legendEl = document.createElement('div');
                legendEl.className = 'legend-item text-gray-300';
                legendEl.innerHTML = `
                    <div class="legend-color" style="background-color: ${color};"></div>
                    <span class="flex-grow">${item.name}</span>
                    <span class="font-semibold">${item.value.toLocaleString()} MW</span>
                    <span class="w-16 text-right text-gray-400">${percentage}%</span>
                `;
                legendContainer.appendChild(legendEl);
            });

            createOrUpdateChart(data);
        }

        function createOrUpdateChart(data) {
            const labels = data.map(item => item.name);
            const values = data.map(item => item.value);
            const colors = data.map(item => {
                 const typeInfo = Object.values(generationTypeMapping).find(t => t.name === item.name);
                 return typeInfo ? typeInfo.color : '#a8a29e';
            });
            
            const chartData = {
                labels: labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors,
                    borderColor: '#4b5563',
                    borderWidth: 2,
                    hoverOffset: 4
                }]
            };

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: true,
                        backgroundColor: '#1f2937',
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.chart.getDatasetMeta(0).total;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${label}: ${value.toLocaleString()} MW (${percentage}%)`;
                            }
                        }
                    }
                }
            };
            
            if (generationMixChart) {
                generationMixChart.data = chartData;
                generationMixChart.update();
            } else {
                generationMixChart = new Chart(generationMixCanvas, {
                    type: 'doughnut',
                    data: chartData,
                    options: chartOptions
                });
            }
        }

        fetchData();
        setInterval(fetchData, REFRESH_INTERVAL_SECONDS * 1000);
    });
    </script>
</body>
</html>

